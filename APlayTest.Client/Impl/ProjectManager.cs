/**
* automatically generated by APlay 2.0.2.1
* www.aplaypowered.com
*/

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Reactive.Disposables;
using System.Runtime.CompilerServices;
using APlay.Common;
using APlay.Common.Utils;
using APlay.Common.DataTypes;
using APlayTest.Client;
using APlayTest.Client.Annotations;
using DynamicData;
using Reactive.Bindings;

namespace APlayTest.Client
{
    public sealed class ProjectManager : APlayTest.Client.ProjectManagerSkeleton, IDisposable
    {
        private readonly SourceCache<ProjectDetail, int> _projectDetailsRx;
        private readonly CompositeDisposable _cleanup;
        /// <summary>
        /// Use this constructor to create instances in your code.
        /// Note: leave the APInitOb null. Aplay sets this object if initialized by aplay.
        ///  if you want to determine in the constructor if the object is user created or by aplay - check IsInitializedByAPlay
        /// </summary>

        public ProjectManager()
        {
            CanJoinProjectRx = new ReactiveProperty<bool>(CanCreateProject,ReactivePropertyMode.RaiseLatestValueOnSubscribe);
            CanCreateProjectRx = new ReactiveProperty<bool>(CanCreateProject,ReactivePropertyMode.RaiseLatestValueOnSubscribe);
            
            SelectedProjectRx = new ReactiveProperty<ProjectDetail>(SelectedProject, ReactivePropertyMode.RaiseLatestValueOnSubscribe);
            var selectedProjectAction = SelectedProjectRx.Subscribe(selected => SelectedProject = selected);

            _projectDetailsRx =  new SourceCache<ProjectDetail, int>(pd => pd.ProjectId);

            _projectDetailsRx.Edit(e =>
            {
                e.AddOrUpdate(ProjectDetails);
            });

            _cleanup = new CompositeDisposable(CanCreateProjectRx, CanJoinProjectRx, SelectedProjectRx,
                _projectDetailsRx, selectedProjectAction);
        }

        public ReactiveProperty<ProjectDetail> SelectedProjectRx { get;private set; }
        public ReactiveProperty<bool> CanJoinProjectRx { get; private set; }
        public ReactiveProperty<bool> CanCreateProjectRx { get; private set; }

        public IObservableCache<ProjectDetail, int> ProjectDetailsRx
        {
            get { return _projectDetailsRx.AsObservableCache(); }
        }

        public override void onCanJoinProjectChange(bool NewCanJoinProject__)
        {
            base.onCanJoinProjectChange(NewCanJoinProject__);
            CanJoinProjectRx.Value = NewCanJoinProject__;
        }

        public override void onCanCreateProjectChange(bool NewCanCreateProject__)
        {
            base.onCanCreateProjectChange(NewCanCreateProject__);
            CanCreateProjectRx.Value = NewCanCreateProject__;
        }

        public override void onProjectDetailsClear()
        {
            base.onProjectDetailsClear();
            _projectDetailsRx.Clear();
        }

        public override void onProjectDetailsAdd(ProjectDetail element)
        {
            base.onProjectDetailsAdd(element);  
           _projectDetailsRx.AddOrUpdate(element);
        }

        public override void onProjectDetailsRemove(ProjectDetail element)
        {
            base.onProjectDetailsRemove(element);
           _projectDetailsRx.Remove(element);
        }

        public override void onProjectDetailsRemoveAt(int pos, ProjectDetail element)
        {
            base.onProjectDetailsRemoveAt(pos, element);
            _projectDetailsRx.Remove(element);
        }

        public override void onProjectDetailsInsertAt(int pos, ProjectDetail element)
        {
            base.onProjectDetailsInsertAt(pos, element);
            _projectDetailsRx.AddOrUpdate(element);
        }

        public override void onSelectedProjectChange(ProjectDetail NewSelectedProject__)
        {
            base.onSelectedProjectChange(NewSelectedProject__);
            
            SelectedProjectRx.Value = NewSelectedProject__;
        }


        public void Dispose()
        {
            _cleanup.Dispose();
        }
    }

}
